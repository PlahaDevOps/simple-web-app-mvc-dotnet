name: IIS Blue-Green Deploy (SimpleWebAppMVC)

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch: {}

env:
  ARTIFACT_NAME: published_app

  BLUE_FARM: blue-farm
  GREEN_FARM: green-farm
  LB_SITE: myapp-lb
  LB_RULE: RouteToActiveSlot   # <-- IMPORTANT: make sure your rule name matches this in myapp-lb

  BLUE_A_PATH: C:\inetpub\myapp\blue-a
  BLUE_B_PATH: C:\inetpub\myapp\blue-b
  GREEN_A_PATH: C:\inetpub\myapp\green-a
  GREEN_B_PATH: C:\inetpub\myapp\green-b
  ARTIFACT_PATH: C:\inetpub\myapp\_artifacts\out

  BLUE_A_HOST: 127.0.0.2
  BLUE_B_HOST: 127.0.0.3
  GREEN_A_HOST: 127.0.0.4
  GREEN_B_HOST: 127.0.0.5

  LB_PORT: 9090
  HEALTH_PATH: /health

jobs:
  build:
    name: Build & Publish (GitHub runner)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET 9 SDK (Linux)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Restore
        run: dotnet restore SimpleWebAppMVC/SimpleWebAppMVC.csproj

      - name: Build
        run: dotnet build SimpleWebAppMVC/SimpleWebAppMVC.csproj -c Release --no-restore

      - name: Publish
        run: dotnet publish SimpleWebAppMVC/SimpleWebAppMVC.csproj -c Release -o out

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: out

  deploy:
    name: Deploy & Swap (Self-hosted IIS)
    needs: build
    runs-on: [self-hosted, Windows, X64]
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_PATH }}

      - name: Deploy to inactive farm + swap LIVE (ARR Blue/Green)
        shell: powershell
        run: |
          Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process -Force
          $ErrorActionPreference = "Stop"
          Import-Module WebAdministration

          $blueFarm  = "${{ env.BLUE_FARM }}"
          $greenFarm = "${{ env.GREEN_FARM }}"
          $lbSite    = "${{ env.LB_SITE }}"
          $lbRule    = "${{ env.LB_RULE }}"
          $lbPort    = [int]"${{ env.LB_PORT }}"
          $health    = "${{ env.HEALTH_PATH }}"

          $blueAPath  = "${{ env.BLUE_A_PATH }}"
          $blueBPath  = "${{ env.BLUE_B_PATH }}"
          $greenAPath = "${{ env.GREEN_A_PATH }}"
          $greenBPath = "${{ env.GREEN_B_PATH }}"
          $artifact   = "${{ env.ARTIFACT_PATH }}"

          $blueAHost  = "${{ env.BLUE_A_HOST }}"
          $blueBHost  = "${{ env.BLUE_B_HOST }}"
          $greenAHost = "${{ env.GREEN_A_HOST }}"
          $greenBHost = "${{ env.GREEN_B_HOST }}"

          function Assert-ArrProxyEnabled() {
            $enabled = (Get-WebConfigurationProperty -pspath "MACHINE/WEBROOT/APPHOST" -filter "system.webServer/proxy" -name "enabled").Value
            if (-not $enabled) { throw "ARR proxy is disabled. Enable it in ARR Server Proxy Settings." }
          }

          function WarmUp200($url) {
            Write-Host "Health check: $url"
            for ($i=1; $i -le 25; $i++) {
              try {
                $r = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 5
                if ($r.StatusCode -eq 200) { return }
              } catch {}
              Start-Sleep -Seconds 2
            }
            throw "Health check failed (no 200): $url"
          }

          function Get-ActiveFarm() {
            $url = (Get-WebConfigurationProperty -pspath "MACHINE/WEBROOT/APPHOST/$lbSite" `
              -filter "system.webServer/rewrite/rules/rule[@name='$lbRule']/action" -name "url").Value

            if ($url -match "http://([^/]+)/") { return $matches[1] }
            throw "Cannot detect active farm from LB rule action url: $url"
          }

          function Set-ActiveFarm([string]$farm) {
            & "$env:windir\system32\inetsrv\appcmd.exe" set config "$lbSite" `
              -section:system.webServer/rewrite/rules `
              /[name='$lbRule'].action.url:"http://$farm/{R:1}" `
              /commit:apphost | Out-Null
          }

          function Deploy-ToPath($path) {
            if (!(Test-Path $path)) { New-Item -ItemType Directory -Force -Path $path | Out-Null }

            $site = Get-Website | Where-Object { $_.physicalPath -ieq $path } | Select-Object -First 1
            if ($site) {
              Write-Host "Stopping app pool: $($site.applicationPool) (site: $($site.Name))"
              Stop-WebAppPool -Name $site.applicationPool
              Start-Sleep -Seconds 2
            } else {
              Write-Host "No IIS site found with physicalPath: $path"
            }

            Get-ChildItem -Path $path -Force -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
            Copy-Item -Path "$artifact\*" -Destination $path -Recurse -Force

            if ($site) {
              Write-Host "Starting app pool: $($site.applicationPool)"
              Start-WebAppPool -Name $site.applicationPool
            }
          }

          # ---- MAIN ----
          if (!(Test-Path $artifact)) { throw "Artifact path not found: $artifact" }

          Assert-ArrProxyEnabled

          $activeFarm = Get-ActiveFarm

          if ($activeFarm -eq $blueFarm) {
            $targetFarm  = $greenFarm
            $targetPaths = @($greenAPath, $greenBPath)
            $targetHosts = @($greenAHost, $greenBHost)
          } else {
            $targetFarm  = $blueFarm
            $targetPaths = @($blueAPath, $blueBPath)
            $targetHosts = @($blueAHost, $blueBHost)
          }

          Write-Host "Active farm: $activeFarm"
          Write-Host "Deploying to inactive farm: $targetFarm"

          foreach ($p in $targetPaths) {
            Write-Host "Deploying to -> $p"
            Deploy-ToPath $p
          }

          Write-Host "Waiting for pools to warm up..."
          Start-Sleep -Seconds 5

          foreach ($h in $targetHosts) {
            WarmUp200 "http://$h$health"
          }

          try {
            Write-Host "Switching LB to: $targetFarm"
            Set-ActiveFarm $targetFarm

            WarmUp200 "http://localhost:$lbPort$health"
            Write-Host "[OK] LIVE farm is now: $targetFarm"
          } catch {
            Write-Host "[ERROR] Swap failed or LB health failed. Rolling back..."
            Set-ActiveFarm $activeFarm
            WarmUp200 "http://localhost:$lbPort$health"
            throw
          }

          Write-Host "[INFO] Keeping all instances running for fast rollback."
